<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Subscription • Makwande Auto Apply</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- set this to your Render backend -->
  <meta name="api-base" content="https://makwande-auto-apply.onrender.com">
</head>
<body class="bg-dark text-light">
  <div class="container py-5" style="max-width:720px;">
    <h1 class="fw-bold">Upgrade to Pro</h1>
    <p class="text-secondary">Unlock Auto Apply automation, saved jobs, document history, and premium tracking.</p>

    <div class="card bg-black border-secondary mb-3">
      <div class="card-body">
        <h4 class="fw-bold">Pro Monthly</h4>
        <div class="display-6">R300 <span class="fs-6 text-secondary">/ month</span></div>
        <ul class="text-secondary mt-3">
          <li>Auto Apply Center + runs history</li>
          <li>Saved Jobs backend</li>
          <li>Documents (CV + Cover Letter) history</li>
          <li>Rules engine (keywords/blacklist/min score)</li>
        </ul>

        <div class="d-grid gap-2 mt-3">
          <button class="btn btn-success btn-lg" id="btnPay">Pay with Paystack</button>
          <a class="btn btn-outline-light" href="/dashboard.html">Back to Dashboard</a>
        </div>

        <div class="mt-3 small" id="status"></div>
      </div>
    </div>
  </div>

  <script src="https://js.paystack.co/v1/inline.js"></script>

  <script>
    const API_BASE = document.querySelector('meta[name="api-base"]').content.replace(/\/$/, "");
    const token = localStorage.getItem("token");
    const statusEl = document.getElementById("status");

    function setStatus(msg, cls="text-secondary"){
      statusEl.className = cls;
      statusEl.textContent = msg;
    }

    async function api(path, opts={}){
      const res = await fetch(API_BASE + path, {
        method: opts.method || "GET",
        headers: {
          "Content-Type": "application/json",
          ...(token ? {"Authorization":"Bearer " + token} : {})
        },
        body: opts.body ? JSON.stringify(opts.body) : undefined
      });
      const data = await res.json().catch(()=> ({}));
      if (!res.ok) throw new Error(data.detail || data.message || "Request failed");
      return data;
    }

    async function fetchPublicKey(){
      // simplest: store public key in backend via env and expose endpoint if you want
      // for now: put your Paystack pk_ in a Pages env replace step later
      return "REPLACE_WITH_PK_FROM_ENV";
    }

    document.getElementById("btnPay").addEventListener("click", async () => {
      try{
        setStatus("Initializing payment…", "text-warning");
        const init = await api("/api/billing/paystack/init", {
          method: "POST",
          body: { plan_code: "PRO_MONTHLY", amount_kobo: 30000, currency: "ZAR" }
        });

        const pk = await fetchPublicKey();

        const handler = PaystackPop.setup({
          key: pk,
          email: "user@unknown", // Paystack still uses init email; safe to leave placeholder
          amount: 30000,
          currency: "ZAR",
          ref: init.reference,
          callback: async function(response){
            setStatus("Verifying payment…", "text-warning");
            const verify = await api("/api/billing/paystack/verify", {
              method:"POST",
              body:{ reference: response.reference }
            });
            if(verify.status === "success"){
              setStatus("Payment verified ✅ Subscription active.", "text-success");
              setTimeout(()=> window.location.href="/dashboard.html", 1200);
            } else {
              setStatus("Payment not successful.", "text-danger");
            }
          },
          onClose: function(){
            setStatus("Payment window closed.", "text-secondary");
          }
        });

        handler.openIframe();
      }catch(e){
        setStatus(e.message, "text-danger");
      }
    });

    // If user lands with ?ref=... (callback)
    (async function(){
      const ref = new URLSearchParams(location.search).get("ref");
      if(ref){
        try{
          setStatus("Verifying reference…", "text-warning");
          const verify = await api("/api/billing/paystack/verify", { method:"POST", body:{ reference: ref }});
          if(verify.status === "success"){
            setStatus("Verified ✅ Subscription active.", "text-success");
            setTimeout(()=> window.location.href="/dashboard.html", 1200);
          } else {
            setStatus("Verification failed.", "text-danger");
          }
        } catch(e){
          setStatus(e.message, "text-danger");
        }
      }
    })();
  </script>
</body>
<script src="assets/js/config.js"></script>
<script src="assets/js/api.js"></script>
<script src="assets/js/auth.js"></script>
<script src="assets/js/ui.js"></script>
<script src="assets/js/app.js"></script>

</html>
